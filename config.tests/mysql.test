#!/bin/sh
#
# param $1: cache file to write to
# param $2: value of MYSQL_LIB, eg. /usr/lib/mysql
# param $3: value of MYSQL_INC, eg. /usr/include/mysql
#

CACHE_FILE=$1
MYSQL_PATH=$2
MYSQL_INC=$3

MYSQL_CLIENT="libmysqlclient.*"
MYSQL_LIB="$MYSQL_CLIENT"
LIB_DIR_SEARCH="/lib /usr/lib /usr/lib/mysql /usr/local/lib"

MYSQL_HEADER="mysql.h"
INC_DIR_SEARCH="/usr/include /usr/include/mysql /usr/local/include /usr/local/include/mysql"


# include all the bits and pieces we need for output
testdir=`dirname $0`
source "$testdir/logging.sh"

# regexps ----------------------------------------------------------
# to strip any trailing slashes from strings
# echo "/path/dir/" | sed -e "s,^\(.*\)\/$,\1,"
# 
# mysql --version 2>&1 | sed -n "s/^.*mysql.*er \([0-9]*\.[0-9.]*\).*/\1/p"
# --> 12.22


# Library check ----------------------------------------------------
found=no
result=no
MYSQL_DIR=

if [ -d "$MYSQL_PATH" ] ; then
  # strip any trailing slashes
  MYSQL_DIR=`echo $MYSQL_PATH | sed -e "s,^\(.*\)\/$,\1,"`
  found_lib=`ls $MYSQL_DIR/$MYSQL_CLIENT 2>/dev/null`
  if [ ! -z "$found_lib" ] ; then
    MYSQL_LIB="$MYSQL_DIR/$MYSQL_CLIENT"
    result="$MYSQL_LIB"
    found=yes
  fi
  # quick 'n dirty check
  if [ -f "$MYSQL_LIB" ] ; then
    MYSQL_DIR=`dirname $MYSQL_LIB`
    result="$MYSQL_LIB/$MYSQL_CLIENT"
    found=yes
  fi
fi

# guess mysql library dir -----------------------------------------
echo "$sh_me:$LINENO: checking for mysql libraries" >&5
echo $ECHO_N "checking for mysql libraries... $ECHO_C" >&6

if [ "$found" = "no" ] ; then
  for dir in $LIB_DIR_SEARCH; do
    found_lib=`ls $dir/$MYSQL_LIB 2>/dev/null`
    if [ ! -z "$found_lib" ] ; then
      MYSQL_DIR="$dir"
      result="$MYSQL_DIR/$MYSQL_LIB"
      found=yes
      break;
    fi
  done
fi

echo "${ECHO_T}$result" >&6

mysql_lib=""
mysql_lib_path=""
if [ "$found" = "yes" ] ; then
  # strip off the '.*' suffix
  lib=`echo $MYSQL_LIB | sed "s,^\([^.]*\).*,\1,"`
  # get the library name
  lib=`basename $lib`
  # strip the 'lib' prefix
  mysql_lib=`echo $lib | sed "s,^lib\([^.]*\).*,\1,"`
  # add on the '-l' bit
  mysql_lib_path="-L$MYSQL_DIR"
  mysql_lib="-l$mysql_lib"
elif [ "$found" = "no" ] ; then
  while true; do
    echo "   Cannot find mysql libraries." >&2
    echo "   Do you want to:"
    echo "   1 - disable mysql"
    echo "   2 - rerun configure with --mysql-lib=/path/to/mysql/libdir" >&2
    echo
    if echo '\c' | grep '\c' >/dev/null; then
      echo -n "Choose 1 or 2:  "
    fi
    read choice
    if [ "$choice" = "1" ] ; then
      exit 0
      break
    elif [ "$choice" = "2" ] ; then
      exit 1
    fi
  done
fi



# Header file check ------------------------------------------------
found=no
result=no
MYSQL_DIR=

echo "$sh_me:$LINENO: checking for $MYSQL_HEADER" >&5
echo $ECHO_N "checking for $MYSQL_HEADER... $ECHO_C" >&6

if [ -z "$MYSQL_INC" ] ; then
  MYSQL_INC="$MYSQL_HEADER"
elif [ -d "$MYSQL_INC" ] ; then
  # we might have been given a dir: strip trailing slashes
  MYSQL_DIR=`echo $MYSQL_INC | sed -e "s,^\(.*\)\/$,\1,"`
  MYSQL_INC="$MYSQL_HEADER"
  if [ -f "$MYSQL_DIR/$MYSQL_INC" ] ; then
    MYSQL_INC="$MYSQL_DIR/$MYSQL_INC"
    result="$MYSQL_INC"
    found=yes
  fi
elif [ -f "$MYSQL_INC" ] ; then
  # allow user to specify a particular header file
  MYSQL_DIR=`dirname $MYSQL_INC`
  result="$MYSQL_INC"
  found=yes
fi

if [ "$found" = "no" ] ; then
  for dir in $INC_DIR_SEARCH; do
    found_hdr=`ls $dir/$MYSQL_INC 2>/dev/null`
    if [ ! -z "$found_hdr" ] ; then
      MYSQL_DIR="$dir"
      found=yes
      result="$MYSQL_DIR/$MYSQL_INC"
      break;
    fi
  done
fi

echo "${ECHO_T}$result" >&6

if [ "$found" = "no" ] ; then
  while true; do
    echo "   Cannot find $MYSQL_HEADER" >&2
    echo "   Do you want to:"
    echo "   1 - disable mysql"
    echo "   2 - rerun configure with --mysql-inc=/path/to/mysql/incdir" >&2
    echo
    if echo '\c' | grep '\c' >/dev/null; then
      echo -n "Choose 1 or 2:  "
    fi
    read choice
    if [ "$choice" = "1" ] ; then
      exit 0
      break
    elif [ "$choice" = "2" ] ; then
      exit 1
    fi
  done
fi

echo "MYSQL_LIB_PATH=$mysql_lib_path" >> $CACHE_FILE
echo "MYSQL_LIB=$mysql_lib" >> $CACHE_FILE
echo "MYSQL_INC=$MYSQL_DIR" >> $CACHE_FILE
exit 0
