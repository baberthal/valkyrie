<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>6.2. Using Massif</title>
<link rel="stylesheet" href="vg_basic.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.64.1">
<link rel="home" href="index.html" title="Valgrind Documentation">
<link rel="up" href="ms-manual.html" title="6. Massif: a heap profiler">
<link rel="previous" href="ms-manual.html" title="6. Massif: a heap profiler">
<link rel="next" href="ms-manual.heapdetails.html" title="6.3. Details of Heap Allocations">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div><table class="nav" width="100%" cellspacing="3" cellpadding="3" border="0" summary="Navigation header"><tr>
<td width="22px" align="center" valign="middle"><a accesskey="p" href="ms-manual.html"><img src="images/prev.png" width="18" height="21" border="0" alt="Prev"></a></td>
<td width="25px" align="center" valign="middle"><a accesskey="u" href="ms-manual.html"><img src="images/up.png" width="21" height="18" border="0" alt="Up"></a></td>
<td width="31px" align="center" valign="middle"><a accesskey="h" href="index.html"><img src="images/home.png" width="27" height="20" border="0" alt="Up"></a></td>
<th align="center" valign="middle">6. Massif: a heap profiler</th>
<td width="22px" align="center" valign="middle"><a accesskey="n" href="ms-manual.heapdetails.html"><img src="images/next.png" width="18" height="21" border="0" alt="Next"></a></td>
</tr></table></div>
<div class="sect1" lang="en">
<div class="titlepage">
<div><div><h2 class="title" style="clear: both">
<a name="ms-manual.using"></a>6.2. Using Massif</h2></div></div>
<div></div>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="ms-manual.overview"></a>6.2.1. Overview</h3></div></div>
<div></div>
</div>
<p>First off, as for normal Valgrind use, you probably want to
compile with debugging info (the
<tt class="computeroutput">-g</tt> flag).  But, as opposed to
Memcheck, you probably <span><b class="command">do</b></span> want to turn
optimisation on, since you should profile your program as it will
be normally run.</p>
<p>Then, run your program with <tt class="computeroutput">valgrind
--tool=massif</tt> in front of the normal command
line invocation.  When the program finishes, Massif will print
summary space statistics.  It also creates a graph representing
the program's heap usage in a file called
<tt class="filename">massif.pid.ps</tt>, which can be read by any
PostScript viewer, such as Ghostview.</p>
<p>It also puts detailed information about heap consumption in
a file <tt class="filename">massif.pid.txt</tt> (text format) or
<tt class="filename">massif.pid.html</tt> (HTML format), where
<span class="emphasis"><em>pid</em></span> is the program's process id.</p>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="ms-manual.basicresults"></a>6.2.2. Basic Results of Profiling</h3></div></div>
<div></div>
</div>
<p>To gather heap profiling information about the program
<tt class="computeroutput">prog</tt>, type:</p>
<pre class="screen">
% valgrind --tool=massif prog</pre>
<p>The program will execute (slowly).  Upon completion,
summary statistics that look like this will be printed:</p>
<pre class="programlisting">
==27519== Total spacetime:   2,258,106 ms.B
==27519== heap:              24.0%
==27519== heap admin:         2.2%
==27519== stack(s):          73.7%</pre>
<p>All measurements are done in
<span class="emphasis"><em>spacetime</em></span>, i.e. space (in bytes) multiplied
by time (in milliseconds).  Note that because Massif slows a
program down a lot, the actual spacetime figure is fairly
meaningless; it's the relative values that are
interesting.</p>
<p>Which entries you see in the breakdown depends on the
command line options given.  The above example measures all the
possible parts of memory:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Heap: number of words allocated on the heap, via
    <tt class="computeroutput">malloc()</tt>,
    <tt class="computeroutput">new</tt> and
    <tt class="computeroutput">new[]</tt>.</p></li>
<li><p>Heap admin: each heap block allocated requires some
    administration data, which lets the allocator track certain
    things about the block.  It is easy to forget about this, and
    if your program allocates lots of small blocks, it can add
    up.  This value is an estimate of the space required for this
    administration data.</p></li>
<li><p>Stack(s): the spacetime used by the programs' stack(s).
    (Threaded programs can have multiple stacks.)  This includes
    signal handler stacks.</p></li>
</ul></div>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="ms-manual.graphs"></a>6.2.3. Spacetime Graphs</h3></div></div>
<div></div>
</div>
<p>As well as printing summary information, Massif also
creates a file representing a spacetime graph,
<tt class="filename">massif.pid.hp</tt>.  It will produce a file
called <tt class="filename">massif.pid.ps</tt>, which can be viewed in
a PostScript viewer.</p>
<p>Massif uses a program called
<tt class="computeroutput">hp2ps</tt> to convert the raw data
into the PostScript graph.  It's distributed with Massif, but
came originally from the 
<a href="http://haskell.cs.yale.edu/ghc/" target="_top">Glasgow Haskell
Compiler</a>.  You shouldn't need to worry about this at all.
However, if the graph creation fails for any reason, Massif will
tell you, and will leave behind a file named
<tt class="filename">massif.pid.hp</tt>, containing the raw heap
profiling data.</p>
<p>Here's an example graph:</p>
<div class="mediaobject">
<a name="spacetime-graph"></a><img src="images/massif-graph-sm.png" alt="Spacetime Graph">
</div>
<p>The graph is broken into several bands.  Most bands
represent a single line of your program that does some heap
allocation; each such band represents all the allocations and
deallocations done from that line.  Up to twenty bands are shown;
less significant allocation sites are merged into "other" and/or
"OTHER" bands.  The accompanying text/HTML file produced by
Massif has more detail about these heap allocation bands.  Then
there are single bands for the stack(s) and heap admin
bytes.</p>
<p><b>Note: </b>it's the height of a band that's important.  Don't let the
ups and downs caused by other bands confuse you.  For example,
the <tt class="computeroutput">read_alias_file</tt> band in the
example has the same height all the time it's in existence.</p>
<p>The triangles on the x-axis show each point at which a
memory census was taken.  These aren't necessarily evenly spread;
Massif only takes a census when memory is allocated or
deallocated.  The time on the x-axis is wallclock time, which is
not ideal because you can get different graphs for different
executions of the same program, due to random OS delays.  But
it's not too bad, and it becomes less of a problem the longer a
program runs.</p>
<p>Massif takes censuses at an appropriate timescale; censuses
take place less frequently as the program runs for longer.  There
is no point having more than 100-200 censuses on a single
graph.</p>
<p>The graphs give a good overview of where your program's
space use comes from, and how that varies over time.  The
accompanying text/HTML file gives a lot more information about
heap use.</p>
</div>
</div>
<div>
<br><table class="nav" width="100%" cellspacing="3" cellpadding="2" border="0" summary="Navigation footer">
<tr>
<td rowspan="2" width="40%" align="left">
<a accesskey="p" href="ms-manual.html">&lt;&lt; 6. Massif: a heap profiler</a> </td>
<td width="20%" align="center"><a accesskey="u" href="ms-manual.html">Up</a></td>
<td rowspan="2" width="40%" align="right"> <a accesskey="n" href="ms-manual.heapdetails.html">6.3. Details of Heap Allocations &gt;&gt;</a>
</td>
</tr>
<tr><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td></tr>
</table>
</div>
</body>
</html>
