<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>3.3. Advanced Topics</title>
<link rel="stylesheet" href="vg_basic.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.65.1">
<link rel="home" href="index.html" title="Valgrind Documentation">
<link rel="up" href="writing-tools.html" title="3. Writing a New Valgrind Tool">
<link rel="previous" href="writing-tools.writingatool.html" title="3.2. Writing a Tool">
<link rel="next" href="writing-tools.finalwords.html" title="3.4. Final Words">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div><table class="nav" width="100%" cellspacing="3" cellpadding="3" border="0" summary="Navigation header"><tr>
<td width="22px" align="center" valign="middle"><a accesskey="p" href="writing-tools.writingatool.html"><img src="images/prev.png" width="18" height="21" border="0" alt="Prev"></a></td>
<td width="25px" align="center" valign="middle"><a accesskey="u" href="writing-tools.html"><img src="images/up.png" width="21" height="18" border="0" alt="Up"></a></td>
<td width="31px" align="center" valign="middle"><a accesskey="h" href="index.html"><img src="images/home.png" width="27" height="20" border="0" alt="Up"></a></td>
<th align="center" valign="middle">3. Writing a New Valgrind Tool</th>
<td width="22px" align="center" valign="middle"><a accesskey="n" href="writing-tools.finalwords.html"><img src="images/next.png" width="18" height="21" border="0" alt="Next"></a></td>
</tr></table></div>
<div class="sect1" lang="en">
<div class="titlepage">
<div><div><h2 class="title" style="clear: both">
<a name="writing-tools.advtopics"></a>3.3. Advanced Topics</h2></div></div>
<div></div>
</div>
<p>Once a tool becomes more complicated, there are some extra
things you may want/need to do.</p>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="writing-tools.suppressions"></a>3.3.1. Suppressions</h3></div></div>
<div></div>
</div>
<p>If your tool reports errors and you want to suppress some
common ones, you can add suppressions to the suppression files.
The relevant files are
<tt class="computeroutput">valgrind/*.supp</tt>; the final
suppression file is aggregated from these files by combining the
relevant <tt class="computeroutput">.supp</tt> files depending
on the versions of linux, X and glibc on a system.</p>
<p>Suppression types have the form
<tt class="computeroutput">tool_name:suppression_name</tt>.  The
<tt class="computeroutput">tool_name</tt> here is the name you
specify for the tool during initialisation with
<tt class="computeroutput">VG_(details_name)()</tt>.</p>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="writing-tools.docs"></a>3.3.2. Documentation</h3></div></div>
<div></div>
</div>
<p>As of version 3.0.0, Valgrind documentation has
been converted to XML. Why? 
See <a href="http://www.ucc.ie/xml/" target="_top">The XML FAQ</a>.
</p>
<div class="sect3" lang="en">
<div class="titlepage">
<div><div><h4 class="title">
<a name="writing-tools.xml"></a>3.3.2.1. The XML Toolchain</h4></div></div>
<div></div>
</div>
<p>If you are feeling conscientious and want to write some
documentation for your tool, please use XML.  The Valgrind
Docs use the following toolchain and versions:</p>
<pre class="programlisting">
 xmllint:   using libxml version 20607
 xsltproc:  using libxml 20607, libxslt 10102 and libexslt 802
 pdfxmltex: pdfTeX (Web2C 7.4.5) 3.14159-1.10b
 pdftops:   version 3.00
 DocBook:   version 4.2
</pre>
<p><span><b class="command">Latency:</b></span> you should note that latency is
a big problem: DocBook is constantly being updated, but the tools
tend to lag behind somewhat.  It is important that the versions
get on with each other, so if you decide to upgrade something,
then you need to ascertain whether things still work nicely -
this *cannot* be assumed.</p>
<p><span><b class="command">Stylesheets:</b></span> The Valgrind docs use
various custom stylesheet layers, all of which are in
<tt class="computeroutput">valgrind/docs/lib/</tt>. You
shouldn't need to modify these in any way.</p>
<p><span><b class="command">Catalogs:</b></span> Assuming that you have the
various tools listed above installed, you will probably need to
modify
<tt class="computeroutput">valgrind/docs/lib/vg-catalog.xml</tt>
so that the parser can find your DocBook installation. Catalogs
provide a mapping from generic addresses to specific local
directories on a given machine.  Just add another
<tt class="computeroutput">group</tt> to this file, reflecting
your local installation.</p>
</div>
<div class="sect3" lang="en">
<div class="titlepage">
<div><div><h4 class="title">
<a name="writing-tools.writing"></a>3.3.2.2. Writing the Documentation</h4></div></div>
<div></div>
</div>
<p>Follow these steps (using <tt class="computeroutput">foobar</tt>
as the example tool name again):</p>
<div class="orderedlist"><ol type="1">
<li><p>Make a directory
  <tt class="computeroutput">valgrind/foobar/docs/</tt>.</p></li>
<li>
<p>Copy the XML documentation file for the tool Nulgrind from
  <tt class="computeroutput">valgrind/none/docs/nl-manual.xml</tt>
  to <tt class="computeroutput">foobar/docs/</tt>, and rename it
  to
  <tt class="computeroutput">foobar/docs/fb-manual.xml</tt>.</p>
<p><span><b class="command">Note</b></span>: there is a *really stupid* tetex
  bug with underscores in filenames, so don't use '_'.</p>
</li>
<li><p>Write the documentation. There are some helpful bits and
  pieces on using xml markup in
  <tt class="filename">valgrind/docs/xml/xml_help.txt</tt>.</p></li>
<li><p>Include it in the User Manual by adding the relevant entry must
  be added to <tt class="filename">valgrind/docs/xml/manual.xml</tt>.  Copy
  and edit an existing entry.</p></li>
<li>
<p>Validate <tt class="computeroutput">foobar/docs/fb-manual.xml</tt>
  using the following command from within <tt class="filename">valgrind/docs/</tt>:
  </p>
<pre class="screen">
% make valid
</pre>
<p>You will probably get errors that look like this:</p>
<pre class="screen">
./xml/index.xml:5: element chapter: validity error : No declaration for
attribute base of element chapter
</pre>
<p>Ignore (only) these -- they're not important.</p>
<p>Because the xml toolchain is fragile, it is important to
  ensure that <tt class="filename">fb-manual.xml</tt> won't
  break the documentation set build.  Note that just because an
  xml file happily transforms to html does not necessarily mean
  the same holds true for pdf/ps.</p>
</li>
<li>
<p>You can (re-)generate the HTML docs
  while you are writing <tt class="filename">fb-manual.xml</tt> to help
  you see how it's looking.  The generated files end up in
  <tt class="filename">valgrind/docs/html/</tt>.  Use the following
  command, within <tt class="filename">valgrind/docs/</tt>:</p>
<pre class="screen">
% make html-docs
</pre>
</li>
<li>
<p>When you have finished, also generate pdf and ps output
  to check all is well, from within <tt class="filename">valgrind/docs/</tt>:
  </p>
<pre class="screen">
% make print-docs
</pre>
<p>Check the output <tt class="filename">.pdf</tt> and
   <tt class="filename">.ps</tt> files in
   <tt class="computeroutput">valgrind/docs/print/</tt>. 
   </p>
</li>
</ol></div>
</div>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="writing-tools.regtests"></a>3.3.3. Regression Tests</h3></div></div>
<div></div>
</div>
<p>Valgrind has some support for regression tests.  If you
want to write regression tests for your tool:</p>
<div class="orderedlist"><ol type="1">
<li><p>Make a directory
  <tt class="computeroutput">foobar/tests/</tt>.</p></li>
<li><p>Edit <tt class="computeroutput">foobar/Makefile.am</tt>,
  adding <tt class="computeroutput">tests</tt> to the
  <tt class="computeroutput">SUBDIRS</tt> variable.</p></li>
<li><p>Edit <tt class="computeroutput">configure.in</tt>,
  adding <tt class="computeroutput">foobar/tests/Makefile</tt>
  to the <tt class="computeroutput">AC_OUTPUT</tt> list.</p></li>
<li><p>Write
  <tt class="computeroutput">foobar/tests/Makefile.am</tt>.  Use
  <tt class="computeroutput">memcheck/tests/Makefile.am</tt> as
  an example.</p></li>
<li><p>Write the tests, <tt class="computeroutput">.vgtest</tt>
  test description files,
  <tt class="computeroutput">.stdout.exp</tt> and
  <tt class="computeroutput">.stderr.exp</tt> expected output
  files.  (Note that Valgrind's output goes to stderr.)  Some
  details on writing and running tests are given in the comments
  at the top of the testing script
  <tt class="computeroutput">tests/vg_regtest</tt>.</p></li>
<li><p>Write a filter for stderr results
  <tt class="computeroutput">foobar/tests/filter_stderr</tt>.
  It can call the existing filters in
  <tt class="computeroutput">tests/</tt>.  See
  <tt class="computeroutput">memcheck/tests/filter_stderr</tt>
  for an example; in particular note the
  <tt class="computeroutput">$dir</tt> trick that ensures the
  filter works correctly from any directory.</p></li>
</ol></div>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="writing-tools.profiling"></a>3.3.4. Profiling</h3></div></div>
<div></div>
</div>
<p>Nb: as of 25-Mar-2005, the profiling is broken, and has been
for a long time...</p>
<p>To do simple tick-based profiling of a tool, include the
line:</p>
<pre class="programlisting">
  #include "vg_profile.c"</pre>
<p>in the tool somewhere, and rebuild (you may have to
<tt class="computeroutput">make clean</tt> first).  Then run
Valgrind with the <tt class="computeroutput">--profile=yes</tt>
option.</p>
<p>The profiler is stack-based; you can register a profiling
event with
<tt class="computeroutput">VG_(register_profile_event)()</tt>
and then use the <tt class="computeroutput">VGP_PUSHCC</tt> and
<tt class="computeroutput">VGP_POPCC</tt> macros to record time
spent doing certain things.  New profiling event numbers must not
overlap with the core profiling event numbers.  See
<tt class="filename">include/tool.h</tt> for details and Memcheck
for an example.</p>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="writing-tools.mkhackery"></a>3.3.5. Other Makefile Hackery</h3></div></div>
<div></div>
</div>
<p>If you add any directories under
<tt class="computeroutput">valgrind/foobar/</tt>, you will need
to add an appropriate <tt class="filename">Makefile.am</tt> to it, and
add a corresponding entry to the
<tt class="computeroutput">AC_OUTPUT</tt> list in
<tt class="filename">valgrind/configure.in</tt>.</p>
<p>If you add any scripts to your tool (see Cachegrind for an
example) you need to add them to the
<tt class="computeroutput">bin_SCRIPTS</tt> variable in
<tt class="filename">valgrind/foobar/Makefile.am</tt>.</p>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="writing-tools.ifacever"></a>3.3.6. Core/tool Interface Versions</h3></div></div>
<div></div>
</div>
<p>In order to allow for the core/tool interface to evolve
over time, Valgrind uses a basic interface versioning system.
All a tool has to do is use the
<tt class="computeroutput">VG_DETERMINE_INTERFACE_VERSION</tt>
macro exactly once in its code.  If not, a link error will occur
when the tool is built.</p>
<p>The interface version number has the form X.Y.  Changes in
Y indicate binary compatible changes.  Changes in X indicate
binary incompatible changes.  If the core and tool has the same
major version number X they should work together.  If X doesn't
match, Valgrind will abort execution with an explanation of the
problem.</p>
<p>This approach was chosen so that if the interface changes
in the future, old tools won't work and the reason will be
clearly explained, instead of possibly crashing mysteriously.  We
have attempted to minimise the potential for binary incompatible
changes by means such as minimising the use of naked structs in
the interface.</p>
</div>
</div>
<div>
<br><table class="nav" width="100%" cellspacing="3" cellpadding="2" border="0" summary="Navigation footer">
<tr>
<td rowspan="2" width="40%" align="left">
<a accesskey="p" href="writing-tools.writingatool.html">&lt;&lt; 3.2. Writing a Tool</a> </td>
<td width="20%" align="center"><a accesskey="u" href="writing-tools.html">Up</a></td>
<td rowspan="2" width="40%" align="right"> <a accesskey="n" href="writing-tools.finalwords.html">3.4. Final Words &gt;&gt;</a>
</td>
</tr>
<tr><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td></tr>
</table>
</div>
</body>
</html>
