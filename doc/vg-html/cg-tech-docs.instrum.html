<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>2.4. Instrumentation</title>
<link rel="stylesheet" href="vg_basic.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.64.1">
<link rel="home" href="index.html" title="Valgrind Documentation">
<link rel="up" href="cg-tech-docs.html" title="2. How Cachegrind works">
<link rel="previous" href="cg-tech-docs.ccstore.html" title="2.3. Storing cost-centres">
<link rel="next" href="cg-tech-docs.retranslations.html" title="2.5. Handling basic block retranslations">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div><table class="nav" width="100%" cellspacing="3" cellpadding="3" border="0" summary="Navigation header"><tr>
<td width="22px" align="center" valign="middle"><a accesskey="p" href="cg-tech-docs.ccstore.html"><img src="images/prev.png" width="18" height="21" border="0" alt="Prev"></a></td>
<td width="25px" align="center" valign="middle"><a accesskey="u" href="cg-tech-docs.html"><img src="images/up.png" width="21" height="18" border="0" alt="Up"></a></td>
<td width="31px" align="center" valign="middle"><a accesskey="h" href="index.html"><img src="images/home.png" width="27" height="20" border="0" alt="Up"></a></td>
<th align="center" valign="middle">2. How Cachegrind works</th>
<td width="22px" align="center" valign="middle"><a accesskey="n" href="cg-tech-docs.retranslations.html"><img src="images/next.png" width="18" height="21" border="0" alt="Next"></a></td>
</tr></table></div>
<div class="sect1" lang="en">
<div class="titlepage">
<div><div><h2 class="title" style="clear: both">
<a name="cg-tech-docs.instrum"></a>2.4. Instrumentation</h2></div></div>
<div></div>
</div>
<p>The instrumentation pass has two main jobs:</p>
<div class="orderedlist"><ol type="1">
<li><p>Fill in the gaps in the allocated cost centres.</p></li>
<li><p>Add UCode to call the cache simulator for each
   instruction.</p></li>
</ol></div>
<p>The instrumentation pass steps through the UCode and the
cost centres in tandem.  As each original x86 instruction's UCode
is processed, the appropriate gaps in the instructions cost
centre are filled in, for example:</p>
<pre class="programlisting">
|INSTR_CC|      tag         (1 byte)
|5       |      instr_size  (1 bytes)
|(uninit)|      (padding)   (2 bytes)
|i_addr1 |      instr_addr  (4 bytes)
|0       |      I.a         (8 bytes)
|0       |      I.m1        (8 bytes)
|0       |      I.m2        (8 bytes)

|WRITE_CC|      tag         (1 byte)
|7       |      instr_size  (1 byte)
|4       |      data_size   (1 byte)
|(uninit)|      (padding)   (1 byte)
|i_addr2 |      instr_addr  (4 bytes)
|0       |      I.a         (8 bytes)
|0       |      I.m1        (8 bytes)
|0       |      I.m2        (8 bytes)
|0       |      D.a         (8 bytes)
|0       |      D.m1        (8 bytes)
|0       |      D.m2        (8 bytes)</pre>
<p>(Note that this step is not performed if a basic block is
re-translated; see <a href="cg-tech-docs.retranslations.html">Handling basic block retranslations</a> for
more information.)</p>
<p>GCC inserts padding before the
<tt class="computeroutput">instr_size</tt> field so that it is
word aligned.</p>
<p>The instrumentation added to call the cache simulation
function looks like this (instrumentation is indented to
distinguish it from the original UCode):</p>
<pre class="programlisting">
MOVL      $0x0, t20
PUTL      t20, %EAX
  PUSHL     %eax
  PUSHL     %ecx
  PUSHL     %edx
  MOVL      $0x4091F8A4, t46  # address of 1st CC
  PUSHL     t46
  CALLMo    $0x12             # second cachesim function
  CLEARo    $0x4
  POPL      %edx
  POPL      %ecx
  POPL      %eax
INCEIPo   $5

LEA1L     -4(t4), t14
MOVL      $0x99, t18
  MOVL      t14, t42
STL       t18, (t14)
  PUSHL     %eax
  PUSHL     %ecx
  PUSHL     %edx
  PUSHL     t42
  MOVL      $0x4091F8C4, t44  # address of 2nd CC
  PUSHL     t44
  CALLMo    $0x13             # second cachesim function
  CLEARo    $0x8
  POPL      %edx
  POPL      %ecx
  POPL      %eax
INCEIPo   $7</pre>
<p>Consider the first instruction's UCode.  Each call is
surrounded by three <tt class="computeroutput">PUSHL</tt> and
<tt class="computeroutput">POPL</tt> instructions to save and
restore the caller-save registers.  Then the address of the
instruction's cost centre is pushed onto the stack, to be the
first argument to the cache simulation function.  The address is
known at this point because we are doing a simultaneous pass
through the cost centre array.  This means the cost centre lookup
for each instruction is almost free (just the cost of pushing an
argument for a function call).  Then the call to the cache
simulation function for non-memory-reference instructions is made
(note that the <tt class="computeroutput">CALLMo</tt>
UInstruction takes an offset into a table of predefined
functions; it is not an absolute address), and the single
argument is <tt class="computeroutput">CLEAR</tt>ed from the
stack.</p>
<p>The second instruction's UCode is similar.  The only
difference is that, as mentioned before, we have to pass the
address of the data item referenced to the cache simulation
function too.  This explains the <tt class="computeroutput">MOVL t14,
t42</tt> and <tt class="computeroutput">PUSHL
t42</tt> UInstructions.  (Note that the seemingly
redundant <tt class="computeroutput">MOV</tt>ing will probably
be optimised away during register allocation.)</p>
<p>Note that instead of storing unchanging information about
each instruction (instruction size, data size, etc) in its cost
centre, we could have passed in these arguments to the simulation
function.  But this would slow the calls down (two or three extra
arguments pushed onto the stack).  Also it would bloat the UCode
instrumentation by amounts similar to the space required for them
in the cost centre; bloated UCode would also fill the translation
cache more quickly, requiring more translations for large
programs and slowing them down more.</p>
</div>
<div>
<br><table class="nav" width="100%" cellspacing="3" cellpadding="2" border="0" summary="Navigation footer">
<tr>
<td rowspan="2" width="40%" align="left">
<a accesskey="p" href="cg-tech-docs.ccstore.html">&lt;&lt; 2.3. Storing cost-centres</a> </td>
<td width="20%" align="center"><a accesskey="u" href="cg-tech-docs.html">Up</a></td>
<td rowspan="2" width="40%" align="right"> <a accesskey="n" href="cg-tech-docs.retranslations.html">2.5. Handling basic block retranslations &gt;&gt;</a>
</td>
</tr>
<tr><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td></tr>
</table>
</div>
</body>
</html>
