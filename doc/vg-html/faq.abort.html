<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>3. Valgrind aborts unexpectedly</title>
<link rel="stylesheet" href="vg_basic.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.64.1">
<link rel="home" href="index.html" title="Valgrind Documentation">
<link rel="up" href="FAQ.html" title="Valgrind FAQ">
<link rel="previous" href="faq.installing.html" title="2. Compiling, installing and configuring">
<link rel="next" href="faq.unexpected.html" title="4. Valgrind behaves unexpectedly">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div><table class="nav" width="100%" cellspacing="3" cellpadding="3" border="0" summary="Navigation header"><tr>
<td width="22px" align="center" valign="middle"><a accesskey="p" href="faq.installing.html"><img src="images/prev.png" width="18" height="21" border="0" alt="Prev"></a></td>
<td width="25px" align="center" valign="middle"><a accesskey="u" href="FAQ.html"><img src="images/up.png" width="21" height="18" border="0" alt="Up"></a></td>
<td width="31px" align="center" valign="middle"><a accesskey="h" href="index.html"><img src="images/home.png" width="27" height="20" border="0" alt="Up"></a></td>
<th align="center" valign="middle">Valgrind FAQ</th>
<td width="22px" align="center" valign="middle"><a accesskey="n" href="faq.unexpected.html"><img src="images/next.png" width="18" height="21" border="0" alt="Next"></a></td>
</tr></table></div>
<div class="chapter" lang="en">
<div class="titlepage">
<div><div><h2 class="title">
<a name="faq.abort"></a>3. Valgrind aborts unexpectedly</h2></div></div>
<div></div>
</div>
<div class="qandaset">
<dl>
<dt>3.1. <a href="faq.abort.html#faq.exit_errors">Programs run OK on Valgrind, but at exit produce a bunch
  of errors a bit like this:</a>
</dt>
<dt>3.2. <a href="faq.abort.html#faq.bugdeath">My (buggy) program dies like this:</a>
</dt>
<dt>3.3. <a href="faq.abort.html#faq.msgdeath">My program dies, printing a message like this along the
    way:</a>
</dt>
</dl>
<table border="0" summary="Q and A Set">
<col align="left" width="1%">
<tbody>
<tr class="question">
<td align="left" valign="top">
<a name="faq.exit_errors"></a><a name="id2544020"></a><b>3.1.</b>
</td>
<td align="left" valign="top"><p>Programs run OK on Valgrind, but at exit produce a bunch
  of errors a bit like this:</p></td>
</tr>
<tr class="answer">
<td> </td>
<td align="left" valign="top">
<p>
</p>
<pre class="programlisting">
==20755== Invalid read of size 4
==20755==    at 0x40281C8A: _nl_unload_locale (loadlocale.c:238)
==20755==    by 0x4028179D: free_mem (findlocale.c:257)
==20755==    by 0x402E0962: __libc_freeres (set-freeres.c:34)
==20755==    by 0x40048DCC: vgPlain___libc_freeres_wrapper (vg_clientfuncs.c:585)
==20755==    Address 0x40CC304C is 8 bytes inside a block of size 380 free'd
==20755==    at 0x400484C9: free (vg_clientfuncs.c:180)
==20755==    by 0x40281CBA: _nl_unload_locale (loadlocale.c:246)
==20755==    by 0x40281218: free_mem (setlocale.c:461)
==20755==    by 0x402E0962: __libc_freeres (set-freeres.c:34)
</pre>
<p>

 and then die with a segmentation fault.</p>
<p>When the program exits, Valgrind runs the procedure
 <tt class="literal">__libc_freeres()</tt> in glibc.  This is a hook
 for memory debuggers, so they can ask glibc to free up any
 memory it has used.  Doing that is needed to ensure that
 Valgrind doesn't incorrectly report space leaks in glibc.</p>
<p>Problem is that running
 <tt class="literal">__libc_freeres()</tt> in older glibc versions
 causes this crash.</p>
<p>WORKAROUND FOR 1.1.X and later
 versions of Valgrind: use the
 <tt class="literal">--run-libc-freeres=no</tt> flag.  You may then get
 space leak reports for glibc-allocations (please _don't_ report
 these to the glibc people, since they are not real leaks), but
 at least the program runs.</p>
</td>
</tr>
<tr><td colspan="2"> </td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="faq.bugdeath"></a><a name="id2590679"></a><b>3.2.</b>
</td>
<td align="left" valign="top"><p>My (buggy) program dies like this:</p></td>
</tr>
<tr class="answer">
<td> </td>
<td align="left" valign="top">
<pre class="screen">
% valgrind: vg_malloc2.c:442 (bszW_to_pszW): Assertion 'pszW &gt;= 0' failed.
</pre>
<p>If Memcheck (the memory checker) shows any invalid reads,
  invalid writes and invalid frees in your program, the above may
  happen.  Reason is that your program may trash Valgrind's
  low-level memory manager, which then dies with the above
  assertion, or something like this.  The cure is to fix your
  program so that it doesn't do any illegal memory accesses.  The
  above failure will hopefully go away after that.</p>
</td>
</tr>
<tr><td colspan="2"> </td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="faq.msgdeath"></a><a name="id2624387"></a><b>3.3.</b>
</td>
<td align="left" valign="top"><p>My program dies, printing a message like this along the
    way:</p></td>
</tr>
<tr class="answer">
<td> </td>
<td align="left" valign="top">
<pre class="screen">
% disInstr: unhandled instruction bytes: 0x66 0xF 0x2E 0x5
</pre>
<p>Older versions did not support some x86 instructions,
  particularly SSE/SSE2 instructions.  Try a newer Valgrind; we
  now support almost all instructions.  If it still happens with
  newer versions, if the failing instruction is an SSE/SSE2
  instruction, you might be able to recompile your program
  without it by using the flag
  <tt class="computeroutput">-march</tt> to gcc.  Either way,
  let us know and we'll try to fix it.</p>
<p>Another possibility is that your program has a bug and
  erroneously jumps to a non-code address, in which case you'll
  get a SIGILL signal.  Memcheck/Addrcheck may issue a warning
  just before this happens, but they might not if the jump
  happens to land in addressable memory.</p>
</td>
</tr>
<tr><td colspan="2"> </td></tr>
</tbody>
</table>
</div>
</div>
<div>
<br><table class="nav" width="100%" cellspacing="3" cellpadding="2" border="0" summary="Navigation footer">
<tr>
<td rowspan="2" width="40%" align="left">
<a accesskey="p" href="faq.installing.html">&lt;&lt; 2. Compiling, installing and configuring</a> </td>
<td width="20%" align="center"><a accesskey="u" href="FAQ.html">Up</a></td>
<td rowspan="2" width="40%" align="right"> <a accesskey="n" href="faq.unexpected.html">4. Valgrind behaves unexpectedly &gt;&gt;</a>
</td>
</tr>
<tr><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td></tr>
</table>
</div>
</body>
</html>
