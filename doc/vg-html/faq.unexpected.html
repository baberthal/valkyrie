<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>4. Valgrind behaves unexpectedly</title>
<link rel="stylesheet" href="vg_basic.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.65.1">
<link rel="home" href="index.html" title="Valgrind Documentation">
<link rel="up" href="FAQ.html" title="Valgrind FAQ">
<link rel="previous" href="faq.abort.html" title="3. Valgrind aborts unexpectedly">
<link rel="next" href="faq.notfound.html" title="5. Memcheck doesn't find my bug">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div><table class="nav" width="100%" cellspacing="3" cellpadding="3" border="0" summary="Navigation header"><tr>
<td width="22px" align="center" valign="middle"><a accesskey="p" href="faq.abort.html"><img src="images/prev.png" width="18" height="21" border="0" alt="Prev"></a></td>
<td width="25px" align="center" valign="middle"><a accesskey="u" href="FAQ.html"><img src="images/up.png" width="21" height="18" border="0" alt="Up"></a></td>
<td width="31px" align="center" valign="middle"><a accesskey="h" href="index.html"><img src="images/home.png" width="27" height="20" border="0" alt="Up"></a></td>
<th align="center" valign="middle">Valgrind FAQ</th>
<td width="22px" align="center" valign="middle"><a accesskey="n" href="faq.notfound.html"><img src="images/next.png" width="18" height="21" border="0" alt="Next"></a></td>
</tr></table></div>
<div class="chapter" lang="en">
<div class="titlepage">
<div><div><h2 class="title">
<a name="faq.unexpected"></a>4. Valgrind behaves unexpectedly</h2></div></div>
<div></div>
</div>
<div class="qandaset">
<dl>
<dt>4.1. <a href="faq.unexpected.html#faq.slowthread">My threaded server process runs unbelievably slowly on
  Valgrind.  So slowly, in fact, that at first I thought it had
  completely locked up.</a>
</dt>
<dt>4.2. <a href="faq.unexpected.html#faq.reports">My program uses the C++ STL and string classes.  Valgrind
  reports 'still reachable' memory leaks involving these classes
  at the exit of the program, but there should be none.</a>
</dt>
<dt>4.3. <a href="faq.unexpected.html#faq.unhelpful">The stack traces given by Memcheck (or another tool)
  aren't helpful.  How can I improve them?</a>
</dt>
<dt>4.4. <a href="faq.unexpected.html#faq.aliases">The stack traces given by Memcheck (or another tool) seem to
  have the wrong function name in them.  What's happening?</a>
</dt>
</dl>
<table border="0" summary="Q and A Set">
<col align="left" width="1%">
<tbody>
<tr class="question">
<td align="left" valign="top">
<a name="faq.slowthread"></a><a name="id4832959"></a><b>4.1.</b>
</td>
<td align="left" valign="top"><p>My threaded server process runs unbelievably slowly on
  Valgrind.  So slowly, in fact, that at first I thought it had
  completely locked up.</p></td>
</tr>
<tr class="answer">
<td> </td>
<td align="left" valign="top">
<p>We are not completely sure about this, but one
  possibility is that laptops with power management fool
  Valgrind's timekeeping mechanism, which is (somewhat in error)
  based on the x86 RDTSC instruction.  A "fix" which is claimed
  to work is to run some other cpu-intensive process at the same
  time, so that the laptop's power-management clock-slowing does
  not kick in.  We would be interested in hearing more feedback
  on this.</p>
<p>Another possible cause is that versions prior to 1.9.6
  did not support threading on glibc 2.3.X systems well.
  Hopefully the situation is much improved with 1.9.6 and later
  versions.</p>
</td>
</tr>
<tr><td colspan="2"> </td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="faq.reports"></a><a name="id4809745"></a><b>4.2.</b>
</td>
<td align="left" valign="top"><p>My program uses the C++ STL and string classes.  Valgrind
  reports 'still reachable' memory leaks involving these classes
  at the exit of the program, but there should be none.</p></td>
</tr>
<tr class="answer">
<td> </td>
<td align="left" valign="top">
<p>First of all: relax, it's probably not a bug, but a
  feature.  Many implementations of the C++ standard libraries
  use their own memory pool allocators.  Memory for quite a
  number of destructed objects is not immediately freed and given
  back to the OS, but kept in the pool(s) for later re-use.  The
  fact that the pools are not freed at the exit() of the program
  cause Valgrind to report this memory as still reachable.  The
  behaviour not to free pools at the exit() could be called a bug
  of the library though.</p>
<p>Using gcc, you can force the STL to use malloc and to
  free memory as soon as possible by globally disabling memory
  caching.  Beware!  Doing so will probably slow down your
  program, sometimes drastically.</p>
<div class="itemizedlist"><ul type="disc">
<li><p>With gcc 2.91, 2.95, 3.0 and 3.1, compile all source
    using the STL with <tt class="literal">-D__USE_MALLOC</tt>. Beware!
    This is removed from gcc starting with version 3.3.</p></li>
<li><p>With gcc 3.2.2 and later, you should export the environment
    variable <tt class="literal">GLIBCPP_FORCE_NEW</tt> before running
    your program.</p></li>
<li><p>With gcc 3.4 and later, that variable has changed name to
    <tt class="literal">GLIBCXX_FORCE_NEW</tt>.</p></li>
</ul></div>
<p>There are other ways to disable memory pooling: using the
  <tt class="literal">malloc_alloc</tt> template with your objects (not
  portable, but should work for gcc) or even writing your own
  memory allocators. But all this goes beyond the scope of this
  FAQ.  Start by reading <a href="http://gcc.gnu.org/onlinedocs/libstdc++/ext/howto.html#3" target="_top">
  http://gcc.gnu.org/onlinedocs/libstdc++/ext/howto.html#3</a>
  if you absolutely want to do that. But beware:</p>
<div class="orderedlist"><ol type="1">
<li><p>there are currently changes underway for gcc which are
    not totally reflected in the docs right now ("now" == 26 Apr
    03)</p></li>
<li><p>allocators belong to the more messy parts of the STL
    and people went to great lengths to make it portable across
    platforms. Chances are good that your solution will work on
    your platform, but not on others.</p></li>
</ol></div>
</td>
</tr>
<tr><td colspan="2"> </td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="faq.unhelpful"></a><a name="id4848852"></a><b>4.3.</b>
</td>
<td align="left" valign="top"><p>The stack traces given by Memcheck (or another tool)
  aren't helpful.  How can I improve them?</p></td>
</tr>
<tr class="answer">
<td> </td>
<td align="left" valign="top">
<p>If they're not long enough, use
  <tt class="literal">--num-callers</tt> to make them longer.</p>
<p>If they're not detailed enough, make sure you are
  compiling with <tt class="literal">-g</tt> to add debug information.
  And don't strip symbol tables (programs should be unstripped
  unless you run 'strip' on them; some libraries ship
  stripped).</p>
<p>Also, for leak reports involving shared objects, if the shared
  object is unloaded before the program terminates, Valgrind will discard
  the debug information and the error message will be full of
  <tt class="literal">???</tt> entries.  The workaround here is to avoid calling
  dlclose() on these shared objects.
  </p>
<p>Also, <tt class="literal">-fomit-frame-pointer</tt> and
  <tt class="literal">-fstack-check</tt> can make stack traces
  worse.</p>
<p>Some example sub-traces:</p>
<p>With debug information and unstripped (best):</p>
<pre class="programlisting">
Invalid write of size 1
   at 0x80483BF: really (malloc1.c:20)
   by 0x8048370: main (malloc1.c:9)
</pre>
<p>With no debug information, unstripped:</p>
<pre class="programlisting">
Invalid write of size 1
   at 0x80483BF: really (in /auto/homes/njn25/grind/head5/a.out)
   by 0x8048370: main (in /auto/homes/njn25/grind/head5/a.out)
</pre>
<p>With no debug information, stripped:</p>
<pre class="programlisting">
Invalid write of size 1
   at 0x80483BF: (within /auto/homes/njn25/grind/head5/a.out)
   by 0x8048370: (within /auto/homes/njn25/grind/head5/a.out)
   by 0x42015703: __libc_start_main (in /lib/tls/libc-2.3.2.so)
   by 0x80482CC: (within /auto/homes/njn25/grind/head5/a.out)
</pre>
<p>With debug information and -fomit-frame-pointer:</p>
<pre class="programlisting">
Invalid write of size 1
   at 0x80483C4: really (malloc1.c:20)
   by 0x42015703: __libc_start_main (in /lib/tls/libc-2.3.2.so)
   by 0x80482CC: ??? (start.S:81)
</pre>
<p>A leak error message involving an unloaded shared object:</p>
<pre class="programlisting">
84 bytes in 1 blocks are possibly lost in loss record 488 of 713
   at 0x1B9036DA: operator new(unsigned) (vg_replace_malloc.c:132)
   by 0x1DB63EEB: ???
   by 0x1DB4B800: ???
   by 0x1D65E007: ???
   by 0x8049EE6: main (main.cpp:24)
</pre>
</td>
</tr>
<tr><td colspan="2"> </td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="faq.aliases"></a><a name="id4793814"></a><b>4.4.</b>
</td>
<td align="left" valign="top"><p>The stack traces given by Memcheck (or another tool) seem to
  have the wrong function name in them.  What's happening?</p></td>
</tr>
<tr class="answer">
<td> </td>
<td align="left" valign="top"><p>Occasionally Valgrind stack traces get the wrong function names.
  This is caused by glibc using aliases to effectively give one function two
  names.  Most of the time Valgrind chooses a suitable name, but very
  occasionally it gets it wrong.

  Examples we know of are printing 'bcmp' instead of 'memcmp', 'index'
  instead of 'strchr', and 'rindex' instead of 'strrchr'.</p></td>
</tr>
<tr><td colspan="2"> </td></tr>
</tbody>
</table>
</div>
</div>
<div>
<br><table class="nav" width="100%" cellspacing="3" cellpadding="2" border="0" summary="Navigation footer">
<tr>
<td rowspan="2" width="40%" align="left">
<a accesskey="p" href="faq.abort.html">&lt;&lt; 3. Valgrind aborts unexpectedly</a> </td>
<td width="20%" align="center"><a accesskey="u" href="FAQ.html">Up</a></td>
<td rowspan="2" width="40%" align="right"> <a accesskey="n" href="faq.notfound.html">5. Memcheck doesn't find my bug &gt;&gt;</a>
</td>
</tr>
<tr><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td></tr>
</table>
</div>
</body>
</html>
