<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>5. Cachegrind: a cache profiler</title>
<link rel="stylesheet" href="vg_basic.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.64.1">
<link rel="home" href="index.html" title="Valgrind Documentation">
<link rel="up" href="manual.html" title="Valgrind User Manual">
<link rel="previous" href="ac-manual.html" title="4. Addrcheck: a lightweight memory checker">
<link rel="next" href="cg-manual.profile.html" title="5.2. Profiling programs">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div><table class="nav" width="100%" cellspacing="3" cellpadding="3" border="0" summary="Navigation header"><tr>
<td width="22px" align="center" valign="middle"><a accesskey="p" href="ac-manual.html"><img src="images/prev.png" width="18" height="21" border="0" alt="Prev"></a></td>
<td width="25px" align="center" valign="middle"><a accesskey="u" href="manual.html"><img src="images/up.png" width="21" height="18" border="0" alt="Up"></a></td>
<td width="31px" align="center" valign="middle"><a accesskey="h" href="index.html"><img src="images/home.png" width="27" height="20" border="0" alt="Up"></a></td>
<th align="center" valign="middle">Valgrind User Manual</th>
<td width="22px" align="center" valign="middle"><a accesskey="n" href="cg-manual.profile.html"><img src="images/next.png" width="18" height="21" border="0" alt="Next"></a></td>
</tr></table></div>
<div class="chapter" lang="en">
<div class="titlepage">
<div><div><h2 class="title">
<a name="cg-manual"></a>5. Cachegrind: a cache profiler</h2></div></div>
<div></div>
</div>
<div class="toc">
<p><b>Table of Contents</b></p>
<dl>
<dt><span class="sect1"><a href="cg-manual.html#cg-manual.cache">5.1. Cache profiling</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="cg-manual.html#cg-manual.overview">5.1.1. Overview</a></span></dt>
<dt><span class="sect2"><a href="cg-manual.html#cache-sim">5.1.2. Cache simulation specifics</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="cg-manual.profile.html">5.2. Profiling programs</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="cg-manual.profile.html#cg-manual.outputfile">5.2.1. Output file</a></span></dt>
<dt><span class="sect2"><a href="cg-manual.profile.html#cg-manual.cgopts">5.2.2. Cachegrind options</a></span></dt>
<dt><span class="sect2"><a href="cg-manual.profile.html#cg-manual.annotate">5.2.3. Annotating C/C++ programs</a></span></dt>
<dt><span class="sect2"><a href="cg-manual.profile.html#cg-manual.assembler">5.2.4. Annotating assembler programs</a></span></dt>
</dl></dd>
<dt><span class="sect1"><a href="cg-manual.annopts.html">5.3. cg_annotate options</a></span></dt>
<dd><dl>
<dt><span class="sect2"><a href="cg-manual.annopts.html#id2597291">5.3.1. Warnings</a></span></dt>
<dt><span class="sect2"><a href="cg-manual.annopts.html#id2601886">5.3.2. Things to watch out for</a></span></dt>
<dt><span class="sect2"><a href="cg-manual.annopts.html#id2619763">5.3.3. Accuracy</a></span></dt>
<dt><span class="sect2"><a href="cg-manual.annopts.html#id2629230">5.3.4. Todo</a></span></dt>
</dl></dd>
</dl>
</div>
<p>Detailed technical documentation on how Cachegrind works is
available in <a href="cg-tech-docs.html">How Cachegrind works</a>.  If you only want to know
how to <span><b class="command">use</b></span> it, this is the page you need to
read.</p>
<div class="sect1" lang="en">
<div class="titlepage">
<div><div><h2 class="title" style="clear: both">
<a name="cg-manual.cache"></a>5.1. Cache profiling</h2></div></div>
<div></div>
</div>
<p>To use this tool, you must specify
<tt class="computeroutput">--tool=cachegrind</tt> on the
Valgrind command line.</p>
<p>Cachegrind is a tool for doing cache simulations and
annotating your source line-by-line with the number of cache
misses.  In particular, it records:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>L1 instruction cache reads and misses;</p></li>
<li><p>L1 data cache reads and read misses, writes and write
    misses;</p></li>
<li><p>L2 unified cache reads and read misses, writes and
    writes misses.</p></li>
</ul></div>
<p>On a modern x86 machine, an L1 miss will typically cost
around 10 cycles, and an L2 miss can cost as much as 200
cycles. Detailed cache profiling can be very useful for improving
the performance of your program.</p>
<p>Also, since one instruction cache read is performed per
instruction executed, you can find out how many instructions are
executed per line, which can be useful for traditional profiling
and test coverage.</p>
<p>Any feedback, bug-fixes, suggestions, etc, welcome.</p>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="cg-manual.overview"></a>5.1.1. Overview</h3></div></div>
<div></div>
</div>
<p>First off, as for normal Valgrind use, you probably want to
compile with debugging info (the
<tt class="computeroutput">-g</tt> flag).  But by contrast with
normal Valgrind use, you probably <span><b class="command">do</b></span> want to turn
optimisation on, since you should profile your program as it will
be normally run.</p>
<p>The two steps are:</p>
<div class="orderedlist"><ol type="1">
<li>
<p>Run your program with <tt class="computeroutput">valgrind
    --tool=cachegrind</tt> in front of the normal
    command line invocation.  When the program finishes,
    Cachegrind will print summary cache statistics. It also
    collects line-by-line information in a file
    <tt class="computeroutput">cachegrind.out.pid</tt>, where
    <tt class="computeroutput">pid</tt> is the program's process
    id.</p>
<p>This step should be done every time you want to collect
    information about a new program, a changed program, or about
    the same program with different input.</p>
</li>
<li>
<p>Generate a function-by-function summary, and possibly
    annotate source files, using the supplied
    <tt class="computeroutput">cg_annotate</tt> program. Source
    files to annotate can be specified manually, or manually on
    the command line, or "interesting" source files can be
    annotated automatically with the
    <tt class="computeroutput">--auto=yes</tt> option.  You can
    annotate C/C++ files or assembly language files equally
    easily.</p>
<p>This step can be performed as many times as you like
    for each Step 2.  You may want to do multiple annotations
    showing different information each time.</p>
</li>
</ol></div>
<p>The steps are described in detail in the following
sections.</p>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="cache-sim"></a>5.1.2. Cache simulation specifics</h3></div></div>
<div></div>
</div>
<p>Cachegrind uses a simulation for a machine with a split L1
cache and a unified L2 cache.  This configuration is used for all
(modern) x86-based machines we are aware of.  Old Cyrix CPUs had
a unified I and D L1 cache, but they are ancient history
now.</p>
<p>The more specific characteristics of the simulation are as
follows.</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Write-allocate: when a write miss occurs, the block
    written to is brought into the D1 cache.  Most modern caches
    have this property.</p></li>
<li>
<p>Bit-selection hash function: the line(s) in the cache
    to which a memory block maps is chosen by the middle bits
    M--(M+N-1) of the byte address, where:</p>
<div class="itemizedlist"><ul type="circle">
<li><p>line size = 2^M bytes</p></li>
<li><p>(cache size / line size) = 2^N bytes</p></li>
</ul></div>
</li>
<li><p>Inclusive L2 cache: the L2 cache replicates all the
    entries of the L1 cache.  This is standard on Pentium chips,
    but AMD Athlons use an exclusive L2 cache that only holds
    blocks evicted from L1.  Ditto AMD Durons and most modern
    VIAs.</p></li>
</ul></div>
<p>The cache configuration simulated (cache size,
associativity and line size) is determined automagically using
the CPUID instruction.  If you have an old machine that (a)
doesn't support the CPUID instruction, or (b) supports it in an
early incarnation that doesn't give any cache information, then
Cachegrind will fall back to using a default configuration (that
of a model 3/4 Athlon).  Cachegrind will tell you if this
happens.  You can manually specify one, two or all three levels
(I1/D1/L2) of the cache from the command line using the
<tt class="computeroutput">--I1</tt>,
<tt class="computeroutput">--D1</tt> and
<tt class="computeroutput">--L2</tt> options.</p>
<p>Other noteworthy behaviour:</p>
<div class="itemizedlist"><ul type="disc">
<li>
<p>References that straddle two cache lines are treated as
    follows:</p>
<div class="itemizedlist"><ul type="circle">
<li><p>If both blocks hit --&gt; counted as one hit</p></li>
<li><p>If one block hits, the other misses --&gt; counted
        as one miss.</p></li>
<li><p>If both blocks miss --&gt; counted as one miss (not
        two)</p></li>
</ul></div>
</li>
<li>
<p>Instructions that modify a memory location
    (eg. <tt class="computeroutput">inc</tt> and
    <tt class="computeroutput">dec</tt>) are counted as doing
    just a read, ie. a single data reference.  This may seem
    strange, but since the write can never cause a miss (the read
    guarantees the block is in the cache) it's not very
    interesting.</p>
<p>Thus it measures not the number of times the data cache
    is accessed, but the number of times a data cache miss could
    occur.</p>
</li>
</ul></div>
<p>If you are interested in simulating a cache with different
properties, it is not particularly hard to write your own cache
simulator, or to modify the existing ones in
<tt class="computeroutput">vg_cachesim_I1.c</tt>,
<tt class="computeroutput">vg_cachesim_D1.c</tt>,
<tt class="computeroutput">vg_cachesim_L2.c</tt> and
<tt class="computeroutput">vg_cachesim_gen.c</tt>.  We'd be
interested to hear from anyone who does.</p>
</div>
</div>
</div>
<div>
<br><table class="nav" width="100%" cellspacing="3" cellpadding="2" border="0" summary="Navigation footer">
<tr>
<td rowspan="2" width="40%" align="left">
<a accesskey="p" href="ac-manual.html">&lt;&lt; 4. Addrcheck: a lightweight memory checker</a> </td>
<td width="20%" align="center"><a accesskey="u" href="manual.html">Up</a></td>
<td rowspan="2" width="40%" align="right"> <a accesskey="n" href="cg-manual.profile.html">5.2. Profiling programs &gt;&gt;</a>
</td>
</tr>
<tr><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td></tr>
</table>
</div>
</body>
</html>
